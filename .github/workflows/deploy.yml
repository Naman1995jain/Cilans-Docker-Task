name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          FLASK_APP=run.py
          FLASK_ENV=production
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=postgres
          DB_PORT=5432
          DB_NAME=flaskdb
          DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@postgres:5432/flaskdb
          TEST_DATABASE_URL=postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@postgres:5432/testdb
          PORT=5000
          EOF
      
      - name: Stop existing containers
        run: docker-compose down || true
      
      - name: Build and deploy
        run: |
          docker-compose up -d --build
          echo "Waiting for services to start..."
          sleep 45
      
      - name: Verify deployment
        run: |
          echo "Checking containers..."
          docker-compose ps
          
          echo ""
          echo "Testing health endpoint..."
          for i in {1..20}; do
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "✓ Application is running!"
              echo ""
              echo "========================================"
              echo "DEPLOYMENT SUCCESSFUL!"
              echo "========================================"
              echo ""
              echo "Access your application at:"
              echo "  Frontend: http://localhost"
              echo "  Backend:  http://localhost:5000"
              exit 0
            fi
            echo "Attempt $i/20 - waiting..."
            sleep 3
          done
          
          echo "✗ Health check failed"
          docker-compose logs
          exit 1
